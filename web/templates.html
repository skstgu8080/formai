<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - Kpr Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="/static/css/theme-variables.css">
    <link rel="stylesheet" href="/static/css/input.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="h-full bg-background text-foreground font-sans antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-background" id="main-content">
            <!-- Header -->
            <header class="bg-card/50 border-b border-gray-200 backdrop-blur-sm sticky top-0 z-10">
                <div class="px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-semibold text-card-foreground tracking-tight">HTTP Request Templates</h2>
                            <p class="text-sm text-muted-foreground">Import and manage reusable HTTP request templates</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-md text-muted-foreground hover:text-card-foreground hover:bg-accent"></button>
                            <div class="flex items-center space-x-2 text-sm text-muted-foreground">
                                <div class="h-2 w-2 bg-green-500 rounded-full"></div>
                                <span>Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="p-6 space-y-6">
                <!-- Import Section -->
                <div class="bg-card rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-card-foreground mb-4">ðŸ“¥ Import New Template</h3>

                    <!-- Import Tabs -->
                    <div class="flex space-x-2 mb-4 border-b border-gray-200">
                        <button onclick="showImportTab('fetch')" id="tab-fetch"
                            class="px-4 py-2 border-b-2 border-secondary text-secondary font-medium">
                            Fetch Code
                        </button>
                        <button onclick="showImportTab('har')" id="tab-har"
                            class="px-4 py-2 text-muted-foreground hover:text-foreground">
                            HAR File
                        </button>
                        <button onclick="showImportTab('curl')" id="tab-curl"
                            class="px-4 py-2 text-muted-foreground hover:text-foreground">
                            cURL Command
                        </button>
                    </div>

                    <!-- Fetch Tab -->
                    <div id="import-fetch" class="import-tab">
                        <p class="text-sm text-muted-foreground mb-3">
                            Copy as Fetch from Chrome DevTools Network tab â†’ paste here
                        </p>
                        <textarea id="fetch-code" rows="10"
                            class="w-full p-3 bg-background text-foreground border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                            placeholder="fetch('https://example.com/form', { method: 'POST', headers: {...}, body: '...' })"></textarea>
                        <button onclick="importFetch()"
                            class="mt-3 bg-secondary hover:bg-secondary/90 text-secondary-foreground px-6 py-2 rounded-md transition-colors">
                            Parse Fetch Code
                        </button>
                    </div>

                    <!-- HAR Tab -->
                    <div id="import-har" class="import-tab hidden">
                        <p class="text-sm text-muted-foreground mb-3">
                            Right-click in DevTools Network tab â†’ "Save all as HAR with content"
                        </p>
                        <input type="file" id="har-file" accept=".har"
                            class="mb-3 block w-full text-sm text-muted-foreground
                                file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                                file:text-sm file:font-semibold file:bg-secondary file:text-secondary-foreground
                                hover:file:bg-secondary/90 file:cursor-pointer">
                        <button onclick="importHAR()"
                            class="bg-secondary hover:bg-secondary/90 text-secondary-foreground px-6 py-2 rounded-md transition-colors">
                            Parse HAR File
                        </button>
                        <div id="har-requests-list" class="mt-4 hidden">
                            <h4 class="font-semibold mb-2">Select Request:</h4>
                            <div id="har-requests" class="space-y-2 max-h-64 overflow-y-auto"></div>
                        </div>
                    </div>

                    <!-- cURL Tab -->
                    <div id="import-curl" class="import-tab hidden">
                        <p class="text-sm text-muted-foreground mb-3">
                            Right-click request in DevTools â†’ Copy â†’ Copy as cURL
                        </p>
                        <textarea id="curl-command" rows="8"
                            class="w-full p-3 bg-background text-foreground border border-input rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                            placeholder="curl 'https://example.com' -H 'User-Agent: ...' --data 'key=value'"></textarea>
                        <button onclick="importCurl()"
                            class="mt-3 bg-secondary hover:bg-secondary/90 text-secondary-foreground px-6 py-2 rounded-md transition-colors">
                            Parse cURL Command
                        </button>
                    </div>

                    <!-- Import Result -->
                    <div id="import-result" class="mt-4 hidden">
                        <div class="bg-green-500/10 border border-green-500/50 rounded-md p-4">
                            <h4 class="font-semibold text-green-600 dark:text-green-400 mb-2">âœ“ Import Successful</h4>
                            <div id="import-details" class="text-sm space-y-1"></div>
                        </div>
                    </div>

                    <!-- Save Template Section -->
                    <div id="save-template-section" class="mt-4 hidden">
                        <div class="bg-blue-500/10 border border-blue-500/50 rounded-md p-4">
                            <h4 class="font-semibold text-blue-600 dark:text-blue-400 mb-3">ðŸ’¾ Save as Template</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Template Name</label>
                                    <input type="text" id="template-name"
                                        class="w-full p-2 bg-background text-foreground border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
                                        placeholder="e.g., Fill.dev Registration Form">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Description (optional)</label>
                                    <input type="text" id="template-description"
                                        class="w-full p-2 bg-background text-foreground border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
                                        placeholder="Brief description of this template">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="template-auto-csrf" checked class="w-4 h-4 rounded border-input">
                                    <label for="template-auto-csrf" class="text-sm">Auto-detect and include CSRF token</label>
                                </div>
                                <button onclick="saveTemplate()"
                                    class="bg-secondary hover:bg-secondary/90 text-secondary-foreground px-6 py-2 rounded-md transition-colors">
                                    Save Template
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Saved Templates Section -->
                <div class="bg-card rounded-lg border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-card-foreground">ðŸ“š Saved Templates</h3>
                        <button onclick="loadSavedTemplates()"
                            class="bg-secondary hover:bg-secondary/90 text-secondary-foreground px-4 py-2 rounded-md text-sm transition-colors">
                            Refresh
                        </button>
                    </div>

                    <!-- Search Box -->
                    <div class="mb-4">
                        <input type="text" id="template-search"
                            class="w-full p-2 bg-background text-foreground border border-input rounded-md focus:outline-none focus:ring-2 focus:ring-ring"
                            placeholder="Search templates by name or URL..."
                            oninput="filterTemplates()">
                    </div>

                    <!-- Templates List -->
                    <div id="templates-list" class="space-y-2">
                        <p class="text-muted-foreground text-center py-8">No saved templates yet. Import and save a request to get started.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/system-status.js"></script>
    <script>
        let currentRequest = null;
        let allTemplates = [];

        // Tab management
        function showImportTab(tab) {
            document.querySelectorAll('.import-tab').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(t => {
                t.classList.remove('border-secondary', 'text-secondary', 'font-medium');
                t.classList.add('text-muted-foreground');
            });

            document.getElementById(`import-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('border-secondary', 'text-secondary', 'font-medium');
        }

        // Import from Fetch code
        async function importFetch() {
            const fetchCode = document.getElementById('fetch-code').value;
            if (!fetchCode.trim()) {
                alert('Please paste fetch code');
                return;
            }

            try {
                const response = await axios.post('/api/http-requests/parse/fetch', { fetch_code: fetchCode });
                currentRequest = response.data;
                showImportSuccess(response.data);
            } catch (error) {
                alert('Failed to parse fetch code: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Import from HAR file
        async function importHAR() {
            const fileInput = document.getElementById('har-file');
            if (!fileInput.files[0]) {
                alert('Please select a HAR file');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const harData = JSON.parse(e.target.result);
                    const entries = harData.log.entries;

                    if (entries.length === 1) {
                        await parseHAREntry(entries[0]);
                    } else {
                        displayHARRequests(entries);
                    }
                } catch (error) {
                    alert('Failed to parse HAR file: ' + error.message);
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        function displayHARRequests(entries) {
            const container = document.getElementById('har-requests');
            container.innerHTML = '';

            entries.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-background border border-input rounded-md hover:border-secondary cursor-pointer';
                div.innerHTML = `
                    <div class="font-semibold">${entry.request.method} ${new URL(entry.request.url).pathname}</div>
                    <div class="text-sm text-muted-foreground">${entry.request.url}</div>
                `;
                div.onclick = () => parseHAREntry(entry);
                container.appendChild(div);
            });

            document.getElementById('har-requests-list').classList.remove('hidden');
        }

        async function parseHAREntry(entry) {
            try {
                const response = await axios.post('/api/http-requests/parse/har', { har_entry: entry });
                currentRequest = response.data;
                showImportSuccess(response.data);
                document.getElementById('har-requests-list').classList.add('hidden');
            } catch (error) {
                alert('Failed to parse HAR entry: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Import from cURL command
        async function importCurl() {
            const curlCommand = document.getElementById('curl-command').value;
            if (!curlCommand.trim()) {
                alert('Please paste cURL command');
                return;
            }

            try {
                const response = await axios.post('/api/http-requests/parse/curl', { curl_command: curlCommand });
                currentRequest = response.data;
                showImportSuccess(response.data);
            } catch (error) {
                alert('Failed to parse cURL command: ' + (error.response?.data?.detail || error.message));
            }
        }

        function showImportSuccess(data) {
            const detailsDiv = document.getElementById('import-details');
            detailsDiv.innerHTML = `
                <div><strong>Method:</strong> ${data.method}</div>
                <div><strong>URL:</strong> ${data.url}</div>
                <div><strong>Headers:</strong> ${Object.keys(data.headers || {}).length} headers</div>
                <div><strong>Form Fields:</strong> ${Object.keys(data.form_data || {}).length} fields</div>
            `;

            document.getElementById('import-result').classList.remove('hidden');
            document.getElementById('save-template-section').classList.remove('hidden');
        }

        // Save template
        async function saveTemplate() {
            if (!currentRequest) {
                alert('Please import a request first');
                return;
            }

            const name = document.getElementById('template-name').value.trim();
            if (!name) {
                alert('Please enter a template name');
                return;
            }

            const description = document.getElementById('template-description').value.trim();
            const detectCsrf = document.getElementById('template-auto-csrf').checked;

            try {
                const response = await axios.post('/api/http-requests/templates', {
                    name: name,
                    url: currentRequest.url,
                    method: currentRequest.method,
                    headers: currentRequest.headers || {},
                    form_data_template: currentRequest.form_data || {},
                    field_mappings: currentRequest.field_mappings || {},
                    detect_csrf: detectCsrf,
                    description: description
                });

                alert('âœ“ Template saved successfully!');

                // Reset form
                document.getElementById('template-name').value = '';
                document.getElementById('template-description').value = '';
                document.getElementById('save-template-section').classList.add('hidden');
                document.getElementById('import-result').classList.add('hidden');
                currentRequest = null;

                // Reload templates
                loadSavedTemplates();
            } catch (error) {
                alert('Failed to save template: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Load saved templates
        async function loadSavedTemplates() {
            try {
                const response = await axios.get('/api/http-requests/templates');
                allTemplates = response.data;
                displayTemplates(allTemplates);
            } catch (error) {
                console.error('Failed to load templates:', error);
                document.getElementById('templates-list').innerHTML = '<p class="text-destructive text-center py-4">Failed to load templates</p>';
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templates-list');

            if (templates.length === 0) {
                container.innerHTML = '<p class="text-muted-foreground text-center py-8">No saved templates yet. Import and save a request to get started.</p>';
                return;
            }

            container.innerHTML = templates.map(template => `
                <div class="bg-background border border-input rounded-md p-4 hover:border-secondary transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-semibold text-card-foreground">${template.name}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded bg-secondary/20 text-secondary">${template.method}</span>
                                ${template.detect_csrf ? '<span class="px-2 py-1 text-xs font-medium rounded bg-blue-500/20 text-blue-400">CSRF</span>' : ''}
                            </div>
                            <div class="text-sm text-muted-foreground mb-2">${template.url}</div>
                            ${template.description ? `<div class="text-sm text-muted-foreground italic mb-2">${template.description}</div>` : ''}
                            <div class="flex items-center gap-4 text-xs text-muted-foreground">
                                <span>${Object.keys(template.field_mappings || {}).length} field mappings</span>
                                <span>${Object.keys(template.headers || {}).length} headers</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="toggleTemplateDetails('${template.id}')"
                                class="text-secondary hover:text-secondary/80 px-3 py-1 rounded-md text-sm">
                                Details
                            </button>
                            <button onclick="deleteTemplate('${template.id}')"
                                class="text-destructive hover:text-destructive/80 px-3 py-1 rounded-md text-sm">
                                Delete
                            </button>
                        </div>
                    </div>
                    <div id="details-${template.id}" class="hidden mt-4 pt-4 border-t border-gray-200 space-y-3">
                        <div>
                            <h5 class="text-sm font-semibold mb-1">Field Mappings:</h5>
                            <pre class="text-xs bg-muted p-2 rounded overflow-x-auto">${JSON.stringify(template.field_mappings, null, 2)}</pre>
                        </div>
                        <div>
                            <h5 class="text-sm font-semibold mb-1">Headers:</h5>
                            <pre class="text-xs bg-muted p-2 rounded overflow-x-auto">${JSON.stringify(template.headers, null, 2)}</pre>
                        </div>
                        <div>
                            <h5 class="text-sm font-semibold mb-1">Form Data Template:</h5>
                            <pre class="text-xs bg-muted p-2 rounded overflow-x-auto">${JSON.stringify(template.form_data_template, null, 2)}</pre>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleTemplateDetails(templateId) {
            const detailsDiv = document.getElementById(`details-${templateId}`);
            detailsDiv.classList.toggle('hidden');
        }

        function filterTemplates() {
            const searchTerm = document.getElementById('template-search').value.toLowerCase();
            const filtered = allTemplates.filter(t =>
                t.name.toLowerCase().includes(searchTerm) ||
                t.url.toLowerCase().includes(searchTerm) ||
                (t.description && t.description.toLowerCase().includes(searchTerm))
            );
            displayTemplates(filtered);
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) {
                return;
            }

            try {
                await axios.delete(`/api/http-requests/templates/${templateId}`);
                alert('âœ“ Template deleted successfully');
                loadSavedTemplates();
            } catch (error) {
                alert('Failed to delete template: ' + (error.response?.data?.detail || error.message));
            }
        }

        // Load templates on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedTemplates();
        });
    </script>
</body>
</html>
