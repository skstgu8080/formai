<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recorder - Kpr Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="/static/css/theme-variables.css">
    <link rel="stylesheet" href="/static/css/input.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .header {
            background: hsl(var(--card));
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: hsl(var(--card-foreground));
            margin-bottom: 20px;
        }

        .capture-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .url-input {
            flex: 1;
            padding: 12px;
            border: 2px solid hsl(var(--border));
            border-radius: 6px;
            font-size: 16px;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .capture-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .capture-btn:hover {
            transform: translateY(-2px);
        }

        .capture-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .options {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .page-card {
            background: hsl(var(--card));
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .page-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .page-screenshot {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: hsl(var(--muted));
        }

        .page-info {
            padding: 15px;
        }

        .page-url {
            font-weight: 600;
            color: hsl(var(--card-foreground));
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-date {
            color: hsl(var(--muted-foreground));
            font-size: 14px;
            margin-bottom: 10px;
        }

        .page-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid hsl(var(--border));
            background: hsl(var(--card));
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            color: hsl(var(--card-foreground));
        }

        .action-btn:hover {
            background: hsl(var(--accent));
        }

        .view-btn {
            background: #667eea;
            color: white;
            border: none;
        }

        .view-btn:hover {
            background: #5a67d8;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: hsl(var(--foreground));
        }

        .no-pages {
            text-align: center;
            padding: 60px;
            background: hsl(var(--card));
            border-radius: 10px;
            color: hsl(var(--muted-foreground));
        }
    </style>
    <script>
        // Instant theme application - prevents flash
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="h-full bg-background text-foreground font-sans antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar will be injected here -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-card border-b border-gray-200">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-card-foreground tracking-tight">Recorder</h2>
                            <p class="text-sm text-muted-foreground">Import and replay Chrome DevTools recordings</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-md text-muted-foreground hover:text-card-foreground hover:bg-accent"></button>
                            <div class="flex items-center space-x-2 text-sm text-muted-foreground">
                                <div class="h-2 w-2 bg-green-500 rounded-full"></div>
                                <span>Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 overflow-auto">
                <div class="p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="header">
                        <h1 class="text-3xl font-bold">FormAI Recorder</h1>
                        <p class="mt-2" style="color: hsl(var(--muted-foreground));">Import Chrome DevTools recordings and replay them with different profiles</p>
                    </div>

                    <!-- Alert Container -->
                    <div id="alertContainer"></div>

                    <!-- Live Recording Section -->
                    <div class="bg-card rounded-lg shadow-sm border border-border p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h2 class="text-xl font-semibold text-card-foreground">üî¥ Live Recording</h2>
                                <p class="text-sm text-muted-foreground mt-1">Record form interactions in real-time with Chrome DevTools</p>
                            </div>
                            <div id="recordingStatusBadge" class="hidden">
                                <span class="flex items-center gap-2 px-3 py-1 bg-red-500 text-white rounded-full text-sm font-medium">
                                    <span class="h-2 w-2 bg-white rounded-full animate-pulse"></span>
                                    Recording...
                                </span>
                            </div>
                        </div>

                        <!-- Start Recording Form -->
                        <div id="startRecordingForm" class="space-y-4">
                            <div>
                                <label for="liveRecordingUrl" class="block text-sm font-medium text-foreground mb-2">Enter URL to Record</label>
                                <input type="url" id="liveRecordingUrl" placeholder="https://example.com/form"
                                       class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       value="">
                            </div>

                            <button id="startRecordingBtn" onclick="startLiveRecording()"
                                    class="w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors font-medium flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <circle cx="10" cy="10" r="6"/>
                                </svg>
                                Start Live Recording
                            </button>

                            <p class="text-xs text-muted-foreground text-center">
                                Chrome DevTools will open the URL. Fill out the form and your actions will be recorded automatically.
                            </p>
                        </div>

                        <!-- Recording Interface (Hidden by default) -->
                        <div id="recordingInterface" class="hidden space-y-4">
                            <!-- Recording Info -->
                            <div class="bg-muted/50 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="text-sm text-muted-foreground mb-1">Recording URL</div>
                                        <div id="recordingUrl" class="text-sm font-mono text-foreground break-all"></div>
                                    </div>
                                    <div class="ml-4 text-right">
                                        <div class="text-sm text-muted-foreground mb-1">Duration</div>
                                        <div id="recordingDuration" class="text-sm font-mono text-foreground">00:00</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Row -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3">
                                    <div class="text-xs text-blue-600 dark:text-blue-400 font-medium">Steps Recorded</div>
                                    <div id="stepsCount" class="text-2xl font-bold text-blue-700 dark:text-blue-300">0</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                                    <div class="text-xs text-green-600 dark:text-green-400 font-medium">Fields Detected</div>
                                    <div id="fieldsCount" class="text-2xl font-bold text-green-700 dark:text-green-300">0</div>
                                </div>
                            </div>

                            <!-- Recent Actions Log -->
                            <div class="border border-border rounded-lg">
                                <div class="bg-muted/50 px-4 py-2 border-b border-border">
                                    <h3 class="text-sm font-medium text-foreground">Recent Actions</h3>
                                </div>
                                <div id="actionsLog" class="p-4 space-y-2 max-h-48 overflow-y-auto">
                                    <div class="text-sm text-muted-foreground text-center py-4">
                                        No actions recorded yet. Start interacting with the form in Chrome DevTools.
                                    </div>
                                </div>
                            </div>

                            <!-- Control Buttons -->
                            <div class="flex gap-3">
                                <button id="stopRecordingBtn" onclick="stopLiveRecording()"
                                        class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors font-medium">
                                    Stop & Save Recording
                                </button>
                                <button onclick="cancelLiveRecording()"
                                        class="bg-secondary hover:bg-secondary/90 text-secondary-foreground py-2 px-4 rounded-md transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Import Section -->
                    <div class="bg-card rounded-lg shadow-sm border border-border p-6 mb-6">
                        <h2 class="text-xl font-semibold text-card-foreground mb-4">Import Chrome Recording</h2>
                        <div class="space-y-4">
                            <!-- File Upload -->
                            <div class="border-2 border-dashed border-input rounded-lg p-6 text-center hover:border-muted-foreground transition-colors">
                                <input type="file" id="chromeRecordingFile" accept=".json" class="hidden">
                                <label for="chromeRecordingFile" class="cursor-pointer">
                                    <svg class="mx-auto h-12 w-12 text-muted-foreground" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="mt-2">
                                        <span class="font-medium text-blue-600">Upload Chrome DevTools Recording</span>
                                        <p class="text-muted-foreground text-sm mt-1">JSON files only</p>
                                    </div>
                                </label>
                            </div>

                            <!-- OR Divider -->
                            <div class="flex items-center gap-4">
                                <div class="flex-1 border-t border-border"></div>
                                <span class="text-sm text-muted-foreground">OR</span>
                                <div class="flex-1 border-t border-border"></div>
                            </div>

                            <!-- Paste JSON -->
                            <div>
                                <label for="recordingJson" class="block text-sm font-medium text-foreground mb-2">Paste Chrome Recording JSON</label>
                                <textarea id="recordingJson"
                                          placeholder='Paste your Chrome DevTools recording JSON here...

Example:
{
  "title": "My Recording",
  "steps": [
    {
      "type": "navigate",
      "url": "https://example.com"
    }
  ]
}'
                                          rows="8"
                                          class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                            </div>

                            <!-- Recording Name Input -->
                            <div>
                                <label for="recordingName" class="block text-sm font-medium text-foreground mb-2">Recording Name (Optional)</label>
                                <input type="text" id="recordingName" placeholder="Enter a custom name for this recording..."
                                       class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Import Button -->
                            <button id="importBtn" onclick="importChromeRecording()" disabled
                                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Import Recording
                            </button>
                        </div>
                    </div>

                    <!-- Recordings Library -->
                    <div class="bg-card rounded-lg shadow-sm border border-border p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-card-foreground">Recordings Library</h2>
                            <div class="flex gap-2">
                                <button onclick="refreshRecordings()"
                                        class="px-3 py-1 text-sm bg-muted text-foreground rounded-md hover:bg-accent transition-colors">
                                    Refresh
                                </button>
                                <select id="filterSource" onchange="filterRecordings()"
                                        class="px-3 py-1 text-sm bg-background text-foreground border border-input rounded-md">
                                    <option value="">All Sources</option>
                                    <option value="chrome_devtools_recorder">Chrome DevTools</option>
                                    <option value="manual">Manual</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="mb-4">
                            <input type="text" id="searchRecordings" placeholder="Search recordings..."
                                   onkeyup="searchRecordings()"
                                   class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Recordings Grid -->
                        <div id="recordingsGrid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Recordings will be populated here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-12 hidden">
                            <svg class="mx-auto h-16 w-16 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-card-foreground">No recordings found</h3>
                            <p class="mt-2 text-muted-foreground">Import a Chrome DevTools recording to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Replay Modal -->
    <div id="replayModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-card-foreground mb-4">Replay Recording</h3>

                <!-- Profile Selection -->
                <div class="mb-4">
                    <label for="profileSelect" class="block text-sm font-medium text-foreground mb-2">Select Profile</label>
                    <select id="profileSelect" class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md">
                        <option value="">Loading profiles...</option>
                    </select>
                </div>

                <!-- Options -->
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="headlessMode" checked class="mr-2">
                        <span class="text-sm text-foreground">Run in headless mode</span>
                    </label>
                </div>

                <!-- Progress -->
                <div id="replayProgress" class="hidden mb-4">
                    <div class="text-sm text-muted-foreground mb-2">Progress: <span id="progressText">0%</span></div>
                    <div class="w-full bg-muted rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progressLog" class="mt-2 text-xs text-muted-foreground max-h-20 overflow-y-auto"></div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3">
                    <button id="startReplayBtn" onclick="startReplay()"
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        Start Replay
                    </button>
                    <button onclick="closeReplayModal()"
                            class="px-4 py-2 text-foreground border border-input rounded-md hover:bg-accent transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card rounded-lg max-w-md w-full p-6">
                <h3 class="text-lg font-medium text-card-foreground mb-4">Create Template</h3>

                <div class="mb-4">
                    <label for="templateName" class="block text-sm font-medium text-foreground mb-2">Template Name</label>
                    <input type="text" id="templateName" placeholder="Enter template name..."
                           class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md">
                </div>

                <div class="mb-4">
                    <label for="templateDescription" class="block text-sm font-medium text-foreground mb-2">Description</label>
                    <textarea id="templateDescription" placeholder="Enter template description..." rows="3"
                              class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md resize-none"></textarea>
                </div>

                <div class="flex gap-3">
                    <button onclick="createTemplate()"
                            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                        Create Template
                    </button>
                    <button onclick="closeTemplateModal()"
                            class="px-4 py-2 text-foreground border border-input rounded-md hover:bg-accent transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/system-status.js"></script>
    <script>
        let currentRecordingId = null;
        let profiles = [];
        let recordings = [];
        let allRecordings = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
            loadRecordings();
            setupFileUpload();
        });

        // Setup file upload and paste handling
        function setupFileUpload() {
            const fileInput = document.getElementById('chromeRecordingFile');
            const jsonTextarea = document.getElementById('recordingJson');
            const importBtn = document.getElementById('importBtn');

            // Enable import button when file is selected
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    jsonTextarea.value = ''; // Clear textarea if file selected
                }
                updateImportButton();
            });

            // Enable import button when text is pasted
            jsonTextarea.addEventListener('input', function(e) {
                const text = e.target.value.trim();
                if (text) {
                    fileInput.value = ''; // Clear file input if text pasted
                }
                updateImportButton();
            });

            function updateImportButton() {
                const hasFile = fileInput.files.length > 0;
                const hasText = jsonTextarea.value.trim().length > 0;
                importBtn.disabled = !hasFile && !hasText;
            }
        }

        // Load profiles for replay selection
        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                profiles = await response.json();

                const select = document.getElementById('profileSelect');
                select.innerHTML = '<option value="">Select a profile...</option>';

                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading profiles:', error);
                showAlert('Error loading profiles', 'error');
            }
        }

        // Load recordings
        async function loadRecordings() {
            try {
                const response = await fetch('/api/recordings');
                allRecordings = await response.json();
                recordings = [...allRecordings];
                displayRecordings();
            } catch (error) {
                console.error('Error loading recordings:', error);
                showAlert('Error loading recordings', 'error');
            }
        }

        // Display recordings in grid
        function displayRecordings() {
            const grid = document.getElementById('recordingsGrid');
            const emptyState = document.getElementById('emptyState');

            if (recordings.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = recordings.map(recording => `
                <div class="border border-border rounded-lg p-4 hover:shadow-md transition-shadow bg-card">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-card-foreground truncate">${recording.recording_name}</h3>
                        <span class="text-xs px-2 py-1 bg-blue-600 text-white rounded-full">
                            ${recording.import_source === 'chrome_devtools_recorder' ? 'Chrome' : 'Manual'}
                        </span>
                    </div>

                    <p class="text-sm text-muted-foreground mb-2 truncate">${recording.url}</p>
                    <p class="text-xs text-muted-foreground mb-3">${recording.total_fields} fields ‚Ä¢ ${recording.created_date}</p>

                    <div class="flex gap-2">
                        <button onclick="openReplayModal('${recording.recording_id}')"
                                class="flex-1 bg-blue-600 text-white text-sm py-1 px-2 rounded hover:bg-blue-700 transition-colors">
                            Replay
                        </button>
                        <button onclick="openTemplateModal('${recording.recording_id}')"
                                class="bg-green-600 text-white text-sm py-1 px-2 rounded hover:bg-green-700 transition-colors">
                            Template
                        </button>
                        <button onclick="deleteRecording('${recording.recording_id}')"
                                class="bg-red-600 text-white text-sm py-1 px-2 rounded hover:bg-red-700 transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Import Chrome recording
        async function importChromeRecording() {
            const fileInput = document.getElementById('chromeRecordingFile');
            const jsonTextarea = document.getElementById('recordingJson');
            const recordingName = document.getElementById('recordingName').value;
            const file = fileInput.files[0];
            const pastedJson = jsonTextarea.value.trim();

            // Check if we have either a file or pasted text
            if (!file && !pastedJson) {
                showAlert('Please upload a file or paste JSON', 'error');
                return;
            }

            try {
                let chromeData;

                // Get JSON from either file or textarea
                if (file) {
                    const fileContent = await file.text();
                    chromeData = JSON.parse(fileContent);
                } else {
                    chromeData = JSON.parse(pastedJson);
                }

                const importData = {
                    chrome_data: chromeData,
                    recording_name: recordingName || null
                };

                const response = await fetch('/api/recordings/import-chrome', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(importData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`Recording imported successfully: ${result.recording_name}`, 'success');

                    // Reset form
                    fileInput.value = '';
                    jsonTextarea.value = '';
                    document.getElementById('recordingName').value = '';
                    document.getElementById('importBtn').disabled = true;

                    // Reload recordings
                    loadRecordings();
                } else {
                    const error = await response.json();
                    showAlert(`Import failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showAlert('Import failed: Invalid JSON file', 'error');
            }
        }

        // Search recordings
        function searchRecordings() {
            const query = document.getElementById('searchRecordings').value.toLowerCase();
            recordings = allRecordings.filter(recording =>
                recording.recording_name.toLowerCase().includes(query) ||
                recording.url.toLowerCase().includes(query) ||
                recording.description.toLowerCase().includes(query)
            );
            applySourceFilter();
        }

        // Filter recordings by source
        function filterRecordings() {
            applySourceFilter();
        }

        function applySourceFilter() {
            const source = document.getElementById('filterSource').value;
            let filtered = recordings;

            if (source) {
                filtered = recordings.filter(recording => recording.import_source === source);
            }

            recordings = filtered;
            displayRecordings();
        }

        // Refresh recordings
        function refreshRecordings() {
            loadRecordings();
            document.getElementById('searchRecordings').value = '';
            document.getElementById('filterSource').value = '';
        }

        // Open replay modal
        function openReplayModal(recordingId) {
            currentRecordingId = recordingId;
            document.getElementById('replayModal').classList.remove('hidden');
            document.getElementById('replayProgress').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('progressLog').innerHTML = '';
        }

        // Close replay modal
        function closeReplayModal() {
            document.getElementById('replayModal').classList.add('hidden');
            currentRecordingId = null;
        }

        // Start replay
        async function startReplay() {
            const profileId = document.getElementById('profileSelect').value;
            const headless = document.getElementById('headlessMode').checked;

            if (!profileId) {
                showAlert('Please select a profile', 'error');
                return;
            }

            try {
                document.getElementById('replayProgress').classList.remove('hidden');
                document.getElementById('startReplayBtn').disabled = true;

                const response = await fetch(`/api/recordings/${currentRecordingId}/replay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        profile_id: profileId,
                        headless: headless
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    monitorReplayProgress(result.task_id);
                } else {
                    const error = await response.json();
                    showAlert(`Replay failed: ${error.detail}`, 'error');
                    document.getElementById('startReplayBtn').disabled = false;
                }
            } catch (error) {
                console.error('Replay error:', error);
                showAlert('Replay failed', 'error');
                document.getElementById('startReplayBtn').disabled = false;
            }
        }

        // Monitor replay progress via WebSocket
        function monitorReplayProgress(taskId) {
            const ws = new WebSocket(`ws://localhost:5511/ws`);

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.task_id === taskId) {
                    updateProgress(data.progress, data.message);

                    if (data.status === 'completed') {
                        showAlert('Replay completed successfully!', 'success');
                        closeReplayModal();
                        ws.close();
                    } else if (data.status === 'failed') {
                        showAlert(`Replay failed: ${data.message}`, 'error');
                        document.getElementById('startReplayBtn').disabled = false;
                        ws.close();
                    }
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                showAlert('Connection error during replay', 'error');
                document.getElementById('startReplayBtn').disabled = false;
            };
        }

        // Update progress display
        function updateProgress(progress, message) {
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${progress}%`;

            const log = document.getElementById('progressLog');
            log.innerHTML += `<div>${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // Template functions
        function openTemplateModal(recordingId) {
            currentRecordingId = recordingId;
            document.getElementById('templateModal').classList.remove('hidden');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.add('hidden');
            currentRecordingId = null;
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
        }

        async function createTemplate() {
            const name = document.getElementById('templateName').value;
            const description = document.getElementById('templateDescription').value;

            if (!name.trim()) {
                showAlert('Please enter a template name', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/recordings/${currentRecordingId}/template`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_name: name,
                        description: description
                    })
                });

                if (response.ok) {
                    showAlert('Template created successfully!', 'success');
                    closeTemplateModal();
                } else {
                    const error = await response.json();
                    showAlert(`Template creation failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Template creation error:', error);
                showAlert('Template creation failed', 'error');
            }
        }

        // Delete recording
        async function deleteRecording(recordingId) {
            if (!confirm('Are you sure you want to delete this recording?')) {
                return;
            }

            try {
                const response = await fetch(`/api/recordings/${recordingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Recording deleted successfully', 'success');
                    loadRecordings();
                } else {
                    showAlert('Failed to delete recording', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete recording', 'error');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type} show`;
            alert.textContent = message;

            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // ======= Live Recording Functions =======
        let recordingStatusInterval = null;
        let recordingDurationInterval = null;
        let recordingStartTime = null;

        // Start live recording
        async function startLiveRecording() {
            const urlInput = document.getElementById('liveRecordingUrl');
            const url = urlInput.value.trim();

            if (!url) {
                showAlert('Please enter a URL to record', 'error');
                return;
            }

            // Validate URL
            try {
                new URL(url);
            } catch (e) {
                showAlert('Please enter a valid URL', 'error');
                return;
            }

            try {
                const response = await fetch('/api/recording/live/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to start recording');
                }

                const result = await response.json();

                // Switch UI to recording interface
                document.getElementById('startRecordingForm').classList.add('hidden');
                document.getElementById('recordingInterface').classList.remove('hidden');
                document.getElementById('recordingStatusBadge').classList.remove('hidden');
                document.getElementById('recordingUrl').textContent = url;

                recordingStartTime = new Date();

                // Start polling for status updates
                startRecordingStatusPolling();

                // Start duration timer
                startDurationTimer();

                showAlert('üî¥ Live recording started! Open Chrome DevTools and interact with the form.', 'success');

                // Open a new window with instructions
                const instructionHtml = `
                    <html>
                    <head>
                        <title>Recording Instructions</title>
                        <style>
                            body { font-family: system-ui; padding: 20px; max-width: 600px; margin: 0 auto; }
                            h1 { color: #dc2626; }
                            .step { background: #f3f4f6; padding: 15px; margin: 10px 0; border-radius: 8px; }
                            .url { background: #1f2937; color: #fff; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
                        </style>
                    </head>
                    <body>
                        <h1>üî¥ Recording in Progress</h1>
                        <div class="url">${url}</div>

                        <div class="step">
                            <strong>Step 1:</strong> Open Chrome DevTools in Claude Code
                        </div>
                        <div class="step">
                            <strong>Step 2:</strong> Navigate to the URL and fill out the form
                        </div>
                        <div class="step">
                            <strong>Step 3:</strong> Each action (fill, click) will be auto-recorded
                        </div>
                        <div class="step">
                            <strong>Step 4:</strong> When done, return to this page and click "Stop & Save Recording"
                        </div>

                        <p><strong>Note:</strong> All your form interactions will be automatically captured!</p>
                    </body>
                    </html>
                `;

                const instructionWindow = window.open('', 'Recording Instructions', 'width=600,height=500');
                if (instructionWindow) {
                    instructionWindow.document.write(instructionHtml);
                }

            } catch (error) {
                console.error('Start recording error:', error);
                showAlert(error.message || 'Failed to start recording', 'error');
            }
        }

        // Poll recording status
        function startRecordingStatusPolling() {
            recordingStatusInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/recording/live/status');
                    if (response.ok) {
                        const status = await response.json();

                        if (status.status === 'recording') {
                            // Update UI with latest stats
                            document.getElementById('stepsCount').textContent = status.steps_recorded || 0;
                            document.getElementById('fieldsCount').textContent = status.field_count || 0;

                            // Update recent actions log
                            if (status.recent_steps && status.recent_steps.length > 0) {
                                updateActionsLog(status.recent_steps);
                            }
                        } else {
                            // Recording stopped externally
                            stopRecordingStatusPolling();
                        }
                    }
                } catch (error) {
                    console.error('Status polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Stop status polling
        function stopRecordingStatusPolling() {
            if (recordingStatusInterval) {
                clearInterval(recordingStatusInterval);
                recordingStatusInterval = null;
            }
        }

        // Start duration timer
        function startDurationTimer() {
            recordingDurationInterval = setInterval(() => {
                if (recordingStartTime) {
                    const elapsed = Math.floor((new Date() - recordingStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('recordingDuration').textContent =
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        // Stop duration timer
        function stopDurationTimer() {
            if (recordingDurationInterval) {
                clearInterval(recordingDurationInterval);
                recordingDurationInterval = null;
            }
        }

        // Update actions log
        function updateActionsLog(recentSteps) {
            const actionsLog = document.getElementById('actionsLog');

            if (recentSteps.length === 0) return;

            // Clear placeholder if present
            if (actionsLog.querySelector('.text-muted-foreground')) {
                actionsLog.innerHTML = '';
            }

            // Display actions (most recent at top)
            actionsLog.innerHTML = recentSteps.reverse().map(step => {
                let icon = '';
                let text = '';
                let colorClass = '';

                if (step.type === 'fill') {
                    icon = '‚úèÔ∏è';
                    text = `Filled <strong>${step.field}</strong>: ${step.value}`;
                    colorClass = 'text-blue-600 dark:text-blue-400';
                } else if (step.type === 'click') {
                    icon = 'üñ±Ô∏è';
                    text = `Clicked <strong>${step.element}</strong>`;
                    colorClass = 'text-green-600 dark:text-green-400';
                } else if (step.type === 'navigate') {
                    icon = 'üåê';
                    text = `Navigated to ${step.url}`;
                    colorClass = 'text-purple-600 dark:text-purple-400';
                }

                return `
                    <div class="flex items-start gap-2 text-sm ${colorClass}">
                        <span class="text-base">${icon}</span>
                        <span>${text}</span>
                    </div>
                `;
            }).join('');
        }

        // Stop recording and save
        async function stopLiveRecording() {
            const recordingName = prompt('Enter a name for this recording:', 'Live Recording - ' + new Date().toLocaleString());

            if (!recordingName) return;

            try {
                const response = await fetch('/api/recording/live/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ recording_name: recordingName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to stop recording');
                }

                const result = await response.json();

                // Stop polling
                stopRecordingStatusPolling();
                stopDurationTimer();

                // Reset UI
                resetRecordingUI();

                // Show success
                showAlert(`‚úÖ Recording saved! ${result.detected_fields} fields detected`, 'success');

                // Refresh recordings list
                setTimeout(() => {
                    refreshRecordings();
                }, 1000);

            } catch (error) {
                console.error('Stop recording error:', error);
                showAlert(error.message || 'Failed to save recording', 'error');
            }
        }

        // Cancel recording
        async function cancelLiveRecording() {
            if (!confirm('Are you sure you want to cancel this recording? All recorded actions will be lost.')) {
                return;
            }

            try {
                await fetch('/api/recording/live/cancel', { method: 'POST' });

                // Stop polling
                stopRecordingStatusPolling();
                stopDurationTimer();

                // Reset UI
                resetRecordingUI();

                showAlert('Recording cancelled', 'info');
            } catch (error) {
                console.error('Cancel recording error:', error);
                showAlert('Failed to cancel recording', 'error');
            }
        }

        // Reset recording UI
        function resetRecordingUI() {
            document.getElementById('startRecordingForm').classList.remove('hidden');
            document.getElementById('recordingInterface').classList.add('hidden');
            document.getElementById('recordingStatusBadge').classList.add('hidden');
            document.getElementById('liveRecordingUrl').value = '';
            document.getElementById('stepsCount').textContent = '0';
            document.getElementById('fieldsCount').textContent = '0';
            document.getElementById('recordingDuration').textContent = '00:00';
            document.getElementById('actionsLog').innerHTML = `
                <div class="text-sm text-muted-foreground text-center py-4">
                    No actions recorded yet. Start interacting with the form in Chrome DevTools.
                </div>
            `;
            recordingStartTime = null;
        }
    </script>
    <script src="/static/js/theme.js"></script>
</body>
</html>