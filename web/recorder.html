<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recorder - Kpr Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
    <link rel="stylesheet" href="/static/css/theme-variables.css">
    <link rel="stylesheet" href="/static/css/input.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .header {
            background: hsl(var(--card));
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: hsl(var(--card-foreground));
            margin-bottom: 20px;
        }

        .capture-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .url-input {
            flex: 1;
            padding: 12px;
            border: 2px solid hsl(var(--border));
            border-radius: 6px;
            font-size: 16px;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .capture-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .capture-btn:hover {
            transform: translateY(-2px);
        }

        .capture-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .options {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .page-card {
            background: hsl(var(--card));
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .page-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .page-screenshot {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: hsl(var(--muted));
        }

        .page-info {
            padding: 15px;
        }

        .page-url {
            font-weight: 600;
            color: hsl(var(--card-foreground));
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .page-date {
            color: hsl(var(--muted-foreground));
            font-size: 14px;
            margin-bottom: 10px;
        }

        .page-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid hsl(var(--border));
            background: hsl(var(--card));
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            color: hsl(var(--card-foreground));
        }

        .action-btn:hover {
            background: hsl(var(--accent));
        }

        .view-btn {
            background: #667eea;
            color: white;
            border: none;
        }

        .view-btn:hover {
            background: #5a67d8;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: hsl(var(--foreground));
        }

        .no-pages {
            text-align: center;
            padding: 60px;
            background: hsl(var(--card));
            border-radius: 10px;
            color: hsl(var(--muted-foreground));
        }
    </style>
    <script>
        // Instant theme application - prevents flash
        (function() {
            const theme = localStorage.getItem('theme') || 'dark';
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="h-full bg-background text-foreground font-sans antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar will be injected here -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="bg-card border-b border-gray-200">
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-semibold text-card-foreground tracking-tight">Recorder</h2>
                            <p class="text-sm text-muted-foreground">Import and replay Chrome DevTools recordings</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="theme-toggle" class="p-2 rounded-md text-muted-foreground hover:text-card-foreground hover:bg-accent"></button>
                            <div class="flex items-center space-x-2 text-sm text-muted-foreground">
                                <div class="h-2 w-2 bg-green-500 rounded-full"></div>
                                <span>Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="flex-1 overflow-auto">
                <div class="p-6">
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="header">
                        <h1 class="text-3xl font-bold">FormAI Recorder</h1>
                        <p class="mt-2" style="color: hsl(var(--muted-foreground));">Import Chrome DevTools recordings and replay them with different profiles</p>
                    </div>

                    <!-- Alert Container -->
                    <div id="alertContainer"></div>

                    <!-- Import Section -->
                    <div class="bg-card rounded-lg shadow-sm border border-border p-6 mb-6">
                        <h2 class="text-xl font-semibold text-card-foreground mb-4">ðŸ“¥ Import Chrome Recording</h2>
                        <p class="text-sm text-muted-foreground mb-4">Record in Chrome DevTools Recorder, then paste the JSON here</p>
                        <div class="space-y-4">
                            <!-- Paste JSON with Real-time Validation -->
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <label for="recordingJson" class="text-sm font-medium text-foreground">
                                        Paste Chrome DevTools Recording JSON
                                    </label>
                                    <div id="validationIndicator" class="hidden items-center gap-2 text-sm">
                                        <span id="validIcon" class="hidden">
                                            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                            </svg>
                                        </span>
                                        <span id="invalidIcon" class="hidden">
                                            <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                            </svg>
                                        </span>
                                        <span id="validationText" class="font-medium"></span>
                                    </div>
                                </div>
                                <textarea id="recordingJson"
                                          placeholder='Paste your Chrome DevTools recording JSON here...

Example:
{
  "title": "My Recording",
  "steps": [
    {
      "type": "navigate",
      "url": "https://example.com"
    }
  ]
}'
                                          rows="10"
                                          class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"></textarea>
                            </div>

                            <!-- JSON Preview (shown when valid) -->
                            <div id="jsonPreview" class="hidden bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
                                <h3 class="text-sm font-medium text-foreground mb-3">Recording Preview</h3>
                                <div class="grid grid-cols-3 gap-3 text-sm">
                                    <div>
                                        <span class="text-muted-foreground">Title:</span>
                                        <div id="previewTitle" class="font-medium text-foreground mt-1"></div>
                                    </div>
                                    <div>
                                        <span class="text-muted-foreground">Steps:</span>
                                        <div id="previewSteps" class="font-medium text-blue-600 dark:text-blue-400 mt-1"></div>
                                    </div>
                                    <div>
                                        <span class="text-muted-foreground">Target URL:</span>
                                        <div id="previewUrl" class="font-medium text-foreground mt-1 truncate"></div>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t border-blue-200 dark:border-blue-700">
                                    <span class="text-xs text-muted-foreground">Detected Fields:</span>
                                    <div id="previewFields" class="mt-1 flex flex-wrap gap-1"></div>
                                </div>
                            </div>

                            <!-- Recording Name Input (auto-filled) -->
                            <div>
                                <label for="recordingName" class="block text-sm font-medium text-foreground mb-2">
                                    Recording Name <span class="text-muted-foreground">(auto-filled from JSON)</span>
                                </label>
                                <input type="text" id="recordingName" placeholder="Will be auto-filled..."
                                       class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <!-- Import Button -->
                            <button id="importBtn" onclick="importChromeRecording()" disabled
                                    class="w-full bg-secondary hover:bg-secondary/90 text-secondary-foreground py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                Import Recording
                            </button>
                        </div>
                    </div>

                    <!-- Recordings Library -->
                    <div class="bg-card rounded-lg shadow-sm border border-border p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-card-foreground">Recordings Library</h2>
                            <div class="flex gap-2">
                                <button onclick="refreshRecordings()"
                                        class="px-3 py-1 text-sm bg-muted text-foreground rounded-md hover:bg-accent transition-colors">
                                    Refresh
                                </button>
                                <select id="filterSource" onchange="filterRecordings()"
                                        class="px-3 py-1 text-sm bg-background text-foreground border border-input rounded-md">
                                    <option value="">All Sources</option>
                                    <option value="chrome_devtools_recorder">Chrome DevTools</option>
                                    <option value="manual">Manual</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="mb-4">
                            <input type="text" id="searchRecordings" placeholder="Search recordings..."
                                   onkeyup="searchRecordings()"
                                   class="w-full px-3 py-2 bg-background text-foreground border border-input rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- Recordings Grid -->
                        <div id="recordingsGrid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                            <!-- Recordings will be populated here -->
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-12 hidden">
                            <svg class="mx-auto h-16 w-16 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="mt-4 text-lg font-medium text-card-foreground">No recordings found</h3>
                            <p class="mt-2 text-muted-foreground">Import a Chrome DevTools recording to get started.</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>
    <!-- Scripts -->
    <script src="/static/js/sidebar.js"></script>
    <script src="/static/js/system-status.js"></script>
    <script>
        let profiles = [];
        let recordings = [];
        let allRecordings = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProfiles();
            loadRecordings();
            setupFileUpload();
        });

        // Setup real-time JSON validation
        let validationTimeout = null;
        let currentValidatedData = null;

        function setupFileUpload() {
            const jsonTextarea = document.getElementById('recordingJson');
            const importBtn = document.getElementById('importBtn');

            // Real-time validation with debouncing
            jsonTextarea.addEventListener('input', function(e) {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(() => {
                    validateAndPreviewJSON(e.target.value);
                }, 500); // Debounce 500ms
            });
        }

        function validateAndPreviewJSON(jsonText) {
            const validationIndicator = document.getElementById('validationIndicator');
            const validIcon = document.getElementById('validIcon');
            const invalidIcon = document.getElementById('invalidIcon');
            const validationText = document.getElementById('validationText');
            const jsonPreview = document.getElementById('jsonPreview');
            const importBtn = document.getElementById('importBtn');
            const recordingNameInput = document.getElementById('recordingName');

            if (!jsonText.trim()) {
                // Hide validation when empty
                validationIndicator.classList.add('hidden');
                jsonPreview.classList.add('hidden');
                importBtn.disabled = true;
                currentValidatedData = null;
                return;
            }

            try {
                // Parse JSON
                const data = JSON.parse(jsonText);
                currentValidatedData = data;

                // Validate Chrome DevTools format
                if (!data.steps || !Array.isArray(data.steps)) {
                    throw new Error('Invalid format: missing "steps" array');
                }

                if (data.steps.length === 0) {
                    throw new Error('No steps found in recording');
                }

                // Valid JSON - show success indicator
                validationIndicator.classList.remove('hidden');
                validationIndicator.classList.add('flex');
                validIcon.classList.remove('hidden');
                invalidIcon.classList.add('hidden');
                validationText.textContent = `Valid Chrome recording`;
                validationText.className = 'font-medium text-green-600 dark:text-green-400';

                // Auto-fill recording name from title
                if (data.title && !recordingNameInput.value) {
                    recordingNameInput.value = data.title;
                }

                // Show preview
                showJSONPreview(data);

                // Enable import button
                importBtn.disabled = false;

            } catch (error) {
                // Invalid JSON - show error
                currentValidatedData = null;
                validationIndicator.classList.remove('hidden');
                validationIndicator.classList.add('flex');
                validIcon.classList.add('hidden');
                invalidIcon.classList.remove('hidden');
                validationText.textContent = error.message || 'Invalid JSON';
                validationText.className = 'font-medium text-red-600 dark:text-red-400';
                jsonPreview.classList.add('hidden');
                importBtn.disabled = true;
            }
        }

        function showJSONPreview(data) {
            const jsonPreview = document.getElementById('jsonPreview');
            const previewTitle = document.getElementById('previewTitle');
            const previewSteps = document.getElementById('previewSteps');
            const previewUrl = document.getElementById('previewUrl');
            const previewFields = document.getElementById('previewFields');

            // Show preview section
            jsonPreview.classList.remove('hidden');

            // Set title
            previewTitle.textContent = data.title || 'Untitled Recording';

            // Set step count
            previewSteps.textContent = `${data.steps.length} steps`;

            // Set target URL
            const navigateStep = data.steps.find(step => step.type === 'navigate');
            if (navigateStep && navigateStep.url) {
                try {
                    const url = new URL(navigateStep.url);
                    previewUrl.textContent = url.hostname;
                    previewUrl.title = navigateStep.url;
                } catch (e) {
                    previewUrl.textContent = navigateStep.url;
                }
            } else {
                previewUrl.textContent = 'No URL detected';
            }

            // Detect and show fields
            const fields = new Set();
            data.steps.forEach(step => {
                if (step.type === 'change' && step.selectors) {
                    // Try to extract field name from selectors
                    step.selectors.forEach(selectorArray => {
                        if (Array.isArray(selectorArray)) {
                            selectorArray.forEach(selector => {
                                // Extract from ARIA selectors like "aria/First name"
                                if (selector.startsWith('aria/')) {
                                    fields.add(selector.replace('aria/', ''));
                                }
                                // Extract from ID selectors like "#email"
                                else if (selector.startsWith('#')) {
                                    fields.add(selector.substring(1));
                                }
                                // Extract from name selectors like 'input[name="email"]'
                                else {
                                    const nameMatch = selector.match(/name=["']([^"']+)["']/);
                                    if (nameMatch) {
                                        fields.add(nameMatch[1]);
                                    }
                                }
                            });
                        }
                    });
                }
            });

            // Display field badges
            previewFields.innerHTML = '';
            if (fields.size > 0) {
                fields.forEach(field => {
                    const badge = document.createElement('span');
                    badge.className = 'px-2 py-1 bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-200 rounded text-xs font-medium';
                    badge.textContent = field;
                    previewFields.appendChild(badge);
                });
            } else {
                previewFields.innerHTML = '<span class="text-xs text-muted-foreground">No input fields detected</span>';
            }
        }

        // Load profiles for replay selection
        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                profiles = await response.json();

                const select = document.getElementById('profileSelect');
                select.innerHTML = '<option value="">Select a profile...</option>';

                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading profiles:', error);
                showAlert('Error loading profiles', 'error');
            }
        }

        // Load recordings
        async function loadRecordings() {
            try {
                const response = await fetch('/api/recordings');
                allRecordings = await response.json();
                recordings = [...allRecordings];
                displayRecordings();
            } catch (error) {
                console.error('Error loading recordings:', error);
                showAlert('Error loading recordings', 'error');
            }
        }

        // Display recordings in grid
        function displayRecordings() {
            const grid = document.getElementById('recordingsGrid');
            const emptyState = document.getElementById('emptyState');

            if (recordings.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = recordings.map(recording => `
                <div class="border border-border rounded-lg p-4 hover:shadow-lg transition-all bg-card relative">
                    <!-- Header with title and badge -->
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="font-semibold text-card-foreground text-base mb-1">${recording.recording_name}</h3>
                            <a href="${recording.url}" target="_blank" class="text-xs text-blue-600 dark:text-blue-400 hover:underline truncate block">
                                ${recording.url}
                            </a>
                        </div>
                        <span class="text-xs px-2 py-1 bg-blue-500 text-white rounded-full ml-2 flex-shrink-0">
                            ${recording.import_source === 'chrome_devtools_recorder' ? 'Chrome' : 'Manual'}
                        </span>
                    </div>

                    <!-- Stats -->
                    <div class="flex gap-3 mb-3 text-xs text-muted-foreground">
                        <span>ðŸ“‹ ${recording.total_fields || 0} fields</span>
                        <span>ðŸ•’ ${recording.created_date}</span>
                    </div>

                    <!-- Profile Selector (inline) -->
                    <div class="mb-3">
                        <select id="profile-${recording.recording_id}"
                                class="w-full px-3 py-2 text-sm bg-background text-foreground border border-input rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select profile to replay...</option>
                            ${profiles.map(profile => `
                                <option value="${profile.id}">${profile.name}</option>
                            `).join('')}
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button onclick="quickReplay('${recording.recording_id}')"
                                class="flex-1 bg-secondary hover:bg-secondary/90 text-secondary-foreground text-sm py-2 px-3 rounded-md transition-colors font-medium flex items-center justify-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                            </svg>
                            Play
                        </button>
                        <button onclick="editRecording('${recording.recording_id}')"
                                class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md transition-colors"
                                title="Edit Selectors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deleteRecording('${recording.recording_id}')"
                                class="bg-destructive hover:bg-destructive/90 text-destructive-foreground text-sm py-2 px-3 rounded-md transition-colors"
                                title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Import Chrome recording
        async function importChromeRecording() {
            const recordingName = document.getElementById('recordingName').value;

            // Use pre-validated data
            if (!currentValidatedData) {
                showAlert('Please paste valid JSON first', 'error');
                return;
            }

            try {
                const importData = {
                    chrome_data: currentValidatedData,
                    recording_name: recordingName || null
                };

                const response = await fetch('/api/recordings/import-chrome', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(importData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`âœ… Recording imported: ${result.recording_name}`, 'success');

                    // Reset form
                    document.getElementById('recordingJson').value = '';
                    document.getElementById('recordingName').value = '';
                    document.getElementById('importBtn').disabled = true;
                    document.getElementById('validationIndicator').classList.add('hidden');
                    document.getElementById('jsonPreview').classList.add('hidden');
                    currentValidatedData = null;

                    // Reload recordings
                    loadRecordings();
                } else {
                    const error = await response.json();
                    showAlert(`âŒ Import failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showAlert('âŒ Import failed: ' + error.message, 'error');
            }
        }

        // Search recordings
        function searchRecordings() {
            const query = document.getElementById('searchRecordings').value.toLowerCase();
            recordings = allRecordings.filter(recording =>
                recording.recording_name.toLowerCase().includes(query) ||
                recording.url.toLowerCase().includes(query) ||
                recording.description.toLowerCase().includes(query)
            );
            applySourceFilter();
        }

        // Filter recordings by source
        function filterRecordings() {
            applySourceFilter();
        }

        function applySourceFilter() {
            const source = document.getElementById('filterSource').value;
            let filtered = recordings;

            if (source) {
                filtered = recordings.filter(recording => recording.import_source === source);
            }

            recordings = filtered;
            displayRecordings();
        }

        // Refresh recordings
        function refreshRecordings() {
            loadRecordings();
            document.getElementById('searchRecordings').value = '';
            document.getElementById('filterSource').value = '';
        }

        // Quick replay with default settings
        async function quickReplay(recordingId) {
            const profileId = document.getElementById(`profile-${recordingId}`).value;

            if (!profileId) {
                showAlert('âš ï¸ Please select a profile first', 'error');
                return;
            }

            // Validate before replay
            try {
                const validationResponse = await fetch(`/api/recordings/${recordingId}/validate/${profileId}`);
                if (validationResponse.ok) {
                    const validation = await validationResponse.json();

                    if (!validation.is_valid && validation.errors.length > 0) {
                        const errorMessages = validation.errors.slice(0, 3).map(e => `â€¢ ${e.message}`).join('\n');
                        const proceed = confirm(`âš ï¸ Validation Issues Found:\n\n${errorMessages}\n\nDo you want to continue anyway?`);
                        if (!proceed) return;
                    } else if (validation.warnings.length > 0) {
                        showAlert(`âš ï¸ ${validation.warnings.length} field(s) may have issues - check profile data`, 'info');
                    }
                }
            } catch (e) {
                console.log('Validation skipped:', e);
            }

            // Use default settings (headless, normal speed)
            const headless = true;
            const stepDelay = 1000; // Normal speed
            const randomVariation = 500; // 50% variation

            try {
                const response = await fetch(`/api/recordings/${recordingId}/replay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        profile_id: profileId,
                        headless: headless,
                        step_delay: stepDelay,
                        random_variation: randomVariation
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('â–¶ï¸ Replay started! Check browser window.', 'success');
                } else {
                    const error = await response.json();
                    showAlert(`âŒ Replay failed: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Replay error:', error);
                showAlert('âŒ Replay failed: ' + error.message, 'error');
            }
        }
        // Edit recording (navigate to editor)
        function editRecording(recordingId) {
            window.location.href = `/recording-editor?id=${recordingId}`;
        }

        // Delete recording
        async function deleteRecording(recordingId) {
            if (!confirm('Are you sure you want to delete this recording?')) {
                return;
            }

            try {
                const response = await fetch(`/api/recordings/${recordingId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showAlert('Recording deleted successfully', 'success');
                    loadRecordings();
                } else {
                    showAlert('Failed to delete recording', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete recording', 'error');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type} show`;
            alert.textContent = message;

            container.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

    </script>
    <script src="/static/js/theme.js"></script>
</body>
</html>